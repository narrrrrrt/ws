<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Wave Player Debug</title>
<style>
html,body{height:100%;margin:0;background:#fff;font-family:ui-monospace,monospace}
#player{display:flex;align-items:center;justify-content:center;gap:12px;height:60vh}
#playBtn{font-size:42px;line-height:1;background:none;border:none;cursor:pointer;color:#111;padding:0 8px}
.wave{display:inline-flex;align-items:flex-end;gap:4px;height:32px}
.wave>span{width:4px;height:10px;background:#111;border-radius:2px;transform-origin:bottom center;animation:wave 1.2s infinite ease-in-out}
.wave>span:nth-child(2){animation-delay:-1.1s}
.wave>span:nth-child(3){animation-delay:-1.0s}
.wave>span:nth-child(4){animation-delay:-0.9s}
.wave>span:nth-child(5){animation-delay:-0.8s}
@keyframes wave{0%,40%,100%{transform:scaleY(0.3)}20%{transform:scaleY(1.0)}}
#debug{font-size:12px;color:#222;background:#f7f7f7;border-top:1px solid #e5e5e5;padding:8px;height:35vh;overflow:auto;white-space:pre-wrap}
</style>
</head>
<body>
<div id="player">
  <button id="playBtn" aria-label="Play">▶</button>
  <audio id="audio" playsinline></audio>
</div>
<div id="debug"></div>
<script>
const log=(msg)=>{const dbg=document.getElementById("debug");
  const time=new Date().toLocaleTimeString("ja-JP",{hour12:false});
  dbg.textContent+=`[${time}] ${msg}\n`;
  dbg.scrollTop=dbg.scrollHeight;
};

document.addEventListener("DOMContentLoaded",()=>{
  const btn=document.getElementById("playBtn");
  const audio=document.getElementById("audio");

  log("DOM ready. waiting for click…");

  btn.addEventListener("click",async()=>{
    log("▶ clicked");

    // ▶を消して波生成
    btn.remove();
    const wave=document.createElement("div");
    wave.className="wave";
    for(let i=0;i<5;i++){wave.appendChild(document.createElement("span"));}
    document.getElementById("player").appendChild(wave);
    log("wave element created");

    try{
      await audio.play(); // iOS 再生許可確保
      log("first silent play() OK");
    }catch(e){log("first play() failed: "+e.name);}

    if(!audio.src){
      audio.src="/m4a"; // Workerの音声
      log("audio.src set to /m4a");
      try{
        await audio.play();
        log("audio.play() started successfully");
      }catch(e){
        log("audio.play() failed after src: "+e.name);
      }
    }
  });

  // 各イベントをログ表示
  ["play","playing","pause","ended","error","stalled","waiting","canplay","canplaythrough"].forEach(ev=>{
    audio.addEventListener(ev,()=>log("event: "+ev));
  });
});
</script>
</body>
</html>
